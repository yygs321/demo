# ì‹¤í–‰í•  ë‹¨ê³„(Stage)ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
stages:
  - build_jar
  - docker_build
  - deploy

# JAR íŒŒì¼ì„ ë¹Œë“œí•˜ëŠ” ì‘ì—…
jar_build:
  stage: build_jar
  image: gradle:8.14-jdk17
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "dev"'
      when: always
    - when: manual
  variables:
    GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - .gradle/
  before_script:
    - echo "ğŸ“Œ [jar_build ë‹¨ê³„ ì‹œì‘] ====================================="
    - chmod +x ./gradlew
  script:
    - echo "ğŸ“¦ Gradle ë¹Œë“œ ì‹œì‘..."
    - ./gradlew clean build -x test

    - echo "âœ… Gradle ë¹Œë“œ ì™„ë£Œ"
  artifacts:
    paths:
      - 'demo-boot/build/libs/*.jar'
    expire_in: 1 days

docker_build:
  stage: docker_build
  needs: [ "jar_build" ] # jarìƒì„± jobì´ ì™„ë£Œëœ í›„ì—ë§Œ ì‘ë™
  image: docker:latest
  before_script:
    - echo "ğŸ“Œ [docker_build ë‹¨ê³„ ì‹œì‘] ===================================="
    - sleep 20
    - ls -alhF demo-boot/build/libs/
  script:
    - echo "ğŸ” Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸ ì‹œì‘..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_ID" --password-stdin "$CI_REGISTRY"
    - echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
    # CI/CD ì„¤ì •ì— ë“±ë¡ëœ DOCKER_IMAGE_NAME ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
    - docker build -t "${CI_REGISTRY}/${DOCKER_REPOSITORY}/${DOCKER_IMAGE_NAME}:${CI_PIPELINE_ID}" .
    - echo "ğŸ·ï¸ Docker ì´ë¯¸ì§€ íƒœê¹…..."
    - docker tag "${CI_REGISTRY}/${DOCKER_REPOSITORY}/${DOCKER_IMAGE_NAME}:${CI_PIPELINE_ID}" "${CI_REGISTRY}/${DOCKER_REPOSITORY}/${DOCKER_IMAGE_NAME}:latest"
    - echo "ğŸš€ Docker ì´ë¯¸ì§€ í‘¸ì‹œ (ë²„ì „ íƒœê·¸)..."
    - docker push "${CI_REGISTRY}/${DOCKER_REPOSITORY}/${DOCKER_IMAGE_NAME}:${CI_PIPELINE_ID}"
    - echo "ğŸš€ Docker ì´ë¯¸ì§€ í‘¸ì‹œ (latest íƒœê·¸)..."
    - docker push "${CI_REGISTRY}/${DOCKER_REPOSITORY}/${DOCKER_IMAGE_NAME}:latest"
    - echo "âœ… ëª¨ë“  Docker ì‘ì—… ì™„ë£Œ"

deploy:
  stage: deploy
  needs: ["docker_build"]
  image: alpine:latest
  before_script:
    - echo "ğŸ“Œ [deploy ë‹¨ê³„ ì‹œì‘] ===================================="
    - apk add --no-cache openssh-client                   # SSH ëª…ë ¹ì–´ ì„¤ì¹˜
    - eval $(ssh-agent -s)                               # ssh-agent ì‹œì‘
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -   # í™˜ê²½ë³€ìˆ˜ ê°œì¸í‚¤ ì¶”ê°€
  script:
    - echo "ğŸ” ì‚¬ë‚´ ì„œë²„ ì ‘ì† ë° Docker ë°°í¬ ì¤€ë¹„..."
    - ssh -p "$DEPLOY_SSH_PORT" -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_SERVER_IP" "
      echo 'ğŸ” Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸ ì‹œì‘...';
      echo '$CI_REGISTRY_PASSWORD' | docker login -u '$CI_REGISTRY_ID' --password-stdin '$CI_REGISTRY';
      echo 'ğŸ³ Docker ì´ë¯¸ì§€ pull ì‹œì‘...';
      docker pull '${CI_REGISTRY}/${DOCKER_REPOSITORY}/${DOCKER_IMAGE_NAME}:${CI_PIPELINE_ID}';
      echo 'â¹ï¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ...';
      docker stop demo-app || true;
      docker rm demo-app || true;
      echo 'ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰...';
      docker run -d --name demo-app -p '$DEPLOY_APP_PORT:8080' '${CI_REGISTRY}/${DOCKER_REPOSITORY}/${DOCKER_IMAGE_NAME}:${CI_PIPELINE_ID}';
      echo 'âœ… ë°°í¬ ì™„ë£Œ';
      "

